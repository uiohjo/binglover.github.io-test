<!doctype html><meta charset="utf-8">
<script type="module">
const params = new URLSearchParams(location.search);
const code = params.get("code");
const verifier = sessionStorage.getItem("pkce_verifier");
const CLIENT_ID = "YOUR_SPOTIFY_CLIENT_ID";
const REDIRECT_URI = location.origin + location.pathname.replace(/\/callback\/?$/,"");

async function exchange() {
  const body = new URLSearchParams({
    client_id: CLIENT_ID,
    grant_type: "authorization_code",
    code,
    redirect_uri: REDIRECT_URI,
    code_verifier: verifier
  });

  // Try direct browser POST to token endpoint (PKCE is allowed for web apps)
  const r = await fetch("https://accounts.spotify.com/api/token", {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body
  });

  if (!r.ok) {
    // If CORS blocks you on your setup, fall back to a tiny serverless proxy (see section below)
    alert("Token exchange failed. You may need the small serverless proxy.");
    return;
  }

  const tok = await r.json();
  const now = Date.now();
  localStorage.setItem("sp_access_token", tok.access_token);
  if (tok.refresh_token) localStorage.setItem("sp_refresh_token", tok.refresh_token);
  localStorage.setItem("sp_expires_at", String(now + (tok.expires_in-60)*1000));
  location.href = REDIRECT_URI + "?spotify=ok";
}
if (code && verifier) exchange();
</script>
